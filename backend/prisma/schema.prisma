generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Level {
  S1
  S2
  S3
}

enum LokasiPos {
  POS_BARAT
  POS_TIMUR
}

enum StatusBarang {
  BELUM_DIAMBIL
  SUDAH_DIAMBIL
}

model Faculty {
  id           String   @id @default(uuid(7))
  code         String   @unique
  name         String
  abbreviation String
  created_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at   DateTime @updatedAt @db.Timestamp(6)

  study_program StudyProgram[]

  @@map("faculties")
}

model StudyProgram {
  id         String   @id @default(uuid(7))
  faculty_id String
  code       String   @unique
  name       String
  level      Level
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  people UserProfile[]

  faculty Faculty @relation(fields: [faculty_id], references: [id], onDelete: Cascade)

  @@map("study_programs")
}

model User {
  id                   String   @id @default(uuid(7)) @db.VarChar(255)
  role_id              String   @db.VarChar(255)
  username             String   @unique @db.VarChar(255)
  password             String   @db.VarChar(255)
  last_update_password DateTime @default(now()) @db.Timestamp(6)
  created_at           DateTime @default(now()) @db.Timestamp(6)
  updated_at           DateTime @updatedAt @db.Timestamp(6)

  // Relasi Auth
  sessions Session[]
  profile  UserProfile?
  role     Role         @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Satpam yang mencatat barang (Input awal)
  barang_dicatat BarangTemuan[] @relation("pencatat_barang")

  // Satpam yang menyerahkan barang (Saat diklaim)
  barang_diserahkan BarangTemuan[] @relation("penyerah_barang")

  @@index([username], name: "idx_username")
  @@map("users")
}

model UserProfile {
  user_id          String     @id @db.VarChar(255)
  study_program_id String?    @db.VarChar(255)
  email            String     @unique @db.VarChar(255)
  nim              String?    @unique @db.VarChar(255)
  nip              String?    @unique @db.VarChar(255)
  full_name        String     @db.VarChar(255)
  lokasi_pos       LokasiPos?
  phone_number     String?    @db.VarChar(20)

  user          User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  study_program StudyProgram? @relation(fields: [study_program_id], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Role {
  id   String @id @default(uuid(7)) @db.VarChar(255)
  name String @db.VarChar(255)

  users User[]

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  @@map("roles")
}

model Session {
  id                   String   @id @default(uuid(7)) @db.VarChar(255)
  jti                  String   @unique @db.VarChar(255)
  user_id              String   @db.VarChar(255)
  hashed_refresh_token String   @db.VarChar(255)
  expires_at           DateTime @db.Timestamp(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model RevokedJwt {
  jti        String   @id @db.VarChar(255)
  expires_at DateTime

  @@map("revoked_jwts")
}

model KategoriBarang {
  id         String   @id @default(uuid(7))
  nama       String   @unique @db.VarChar(255)
  deskripsi  String?  @db.Text
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  daftar_barang BarangTemuan[]

  @@map("kategori_barang")
}

model BarangTemuan {
  id String @id @default(uuid(7))

  // RELASI KE USER (SATPAM)
  pencatat_id String  @db.VarChar(255) // User ID pencatat
  penyerah_id String? @db.VarChar(255) // User ID penyerah

  // RELASI KATEGORI
  kategori_id String @db.VarChar(255)

  // INFO BARANG
  nama_barang               String       @db.VarChar(255)
  status                    StatusBarang @default(BELUM_DIAMBIL)
  deskripsi                 String?      @db.Text
  lokasi_ditemukan          String       @db.VarChar(255)
  tanggal_ditemukan         DateTime     @db.Date
  lokasi_umum               String?      @db.VarChar(255)
  lokasi_spesifik           String?      @db.VarChar(255)
  perkiraan_waktu_ditemukan String?      @db.VarChar(255)

  // Data orang yang menyerahkan ke satpam
  nama_penemu      String  @db.VarChar(255)
  nomor_hp_penemu  String  @db.VarChar(50)
  identitas_penemu String? @db.VarChar(100) // NIM, NIP, atau No KTP
  email_penemu     String? @db.VarChar(255)
  catatan_penemu   String? @db.Text

  // INFO PENGAMBILAN (CLAIM) - Diisi saat barang diambil
  waktu_diambil       DateTime? @db.Timestamp(6)
  nama_pengambil      String?   @db.VarChar(255)
  identitas_pengambil String?   @db.VarChar(100) // NIM, NIP, atau No KTP
  kontak_pengambil    String?   @db.VarChar(50)

  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // RELASI TABEL
  foto_barang FotoBarang[]

  pencatat User           @relation("pencatat_barang", fields: [pencatat_id], references: [id], onDelete: Cascade)
  penyerah User?          @relation("penyerah_barang", fields: [penyerah_id], references: [id], onDelete: Cascade)
  kategori KategoriBarang @relation(fields: [kategori_id], references: [id], onDelete: Cascade)

  @@map("barang_temuan")
}

model FotoBarang {
  id               String   @id @default(uuid(7))
  barang_temuan_id String   @db.VarChar(255)
  url_gambar       String   @db.VarChar(255)
  nama_file_asli   String?  @db.VarChar(255)
  mime_type        String?  @db.VarChar(50)
  created_at       DateTime @default(now()) @db.Timestamp(6)

  barang_temuan BarangTemuan @relation(fields: [barang_temuan_id], references: [id], onDelete: Cascade)

  @@map("foto_barang")
}
